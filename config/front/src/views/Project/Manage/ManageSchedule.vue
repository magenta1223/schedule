<template>
    <v-container>
        <!-- Ìó§Îçî -->
        <v-row class ="mb-4">
            <v-col cols="4">
                <v-select
                    v-model="activeView"
                    :items="activeViewOptions"
                    item-title="name"
                    item-value="name"
                    label="View"
                    density="compact"
                ></v-select>
            </v-col>
            <v-col cols="4">
                <v-btn
                    class ="mr-1"
                    @click="$refs.vuecal.previous()"
                    :icon="icons.mdiArrowLeft"
                    size="small"
                >
                </v-btn>
                <v-btn
                    
                    @click="$refs.vuecal.next()"
                    :icon="icons.mdiArrowRight"
                    size="small"
                >
                </v-btn>
            </v-col>
            <v-col>
                {{selectedDate}}
            </v-col>
            <v-col cols="2">
                <v-btn @click="modal"> SEARCH </v-btn>
            </v-col>
        </v-row>
        
        <!-- Ï∫òÎ¶∞Îçî -->
        <v-row>
            <v-item-group multiple>
                <VueCal
                    ref="vuecal"
                    v-model:selected-date="selectedDate"
                    v-model:active-view="activeView"
                    hide-view-selector
                    hide-title-bar
                    :events="events"
                    :disable-views="disable_views"
                    :time-from="time_from"
                    :time-to="time_to"
                    :time-step="time_step"
                    :events-on-month-view="eomv"
                    :on-event-click="onEventClick"
                    @cell-click="onCellClick"
                >
                    <template #weekday-heading={heading}>
                        <div :style="wdHeaderStyle(heading)">
                            {{wdHeaderText(heading)}}
                        </div>
                    </template>
                    
                    <template #cell-content="{ cell, view, events, goNarrower }" >
                        <div class="vuecal__flex vuecal__cell-content custom-cell" @click="onCellClick(cell)">
                            <!-- <v-row class ="ma-2">
                                {{ cell.content }}
                            </v-row> -->
                            <v-item v-slot="{ isSelected, toggle }">
                                <v-card
                                :color="isSelected ? 'primary' : ''"
                                class="d-flex align-center rounded-0 elevation-0"
                                dark
                                @click="[onCellClick(isSelected, cell), toggle()]"
                                height="100%"
                                width="100%"
                                >
                                <v-card-text class="text-center">
                                    {{cell.content}}
                                    <!-- {{ isSelected ? 'Selected' : 'Click Me!' }} -->
                                </v-card-text>
                                </v-card>
                            </v-item>

                        </div>
                        <span class="vuecal__cell-date" :class="view.id" v-if="view.id === 'day'" @click="goNarrower">
                        {{ cell.content }}
                        </span>
                        <span class="vuecal__cell-events-count" v-if="view.id === 'month' && events.length">{{ events.length }} </span>
                        <span class="vuecal__no-event" v-if="['week', 'day'].includes(view.id) && !events.length">Nothing here üëå</span>
                    </template>
                </VueCal>
            </v-item-group>
        </v-row>
        <!-- Î™®Îã¨ -->
        <v-row>
            <v-dialog
            v-model="openAddMeeting"
            fullscreen
            :scrim="false"
            transition="dialog-bottom-transition"
            >

                <v-card>
                    <!-- Ìà¥Î∞î -->
                    <v-toolbar
                    dark
                    color="primary"
                    >
                        <v-btn
                            :icon="icons.mdiClose"
                            dark
                            @click="openAddMeeting = false"
                        >
                        </v-btn>

                        <v-toolbar-title>
                            Searching best meeting
                        </v-toolbar-title>
                    </v-toolbar>

                    <!-- Ï∞∏Ïó¨ Í∞ÄÎä• Ïù∏Ïõê Î∞õÏïÑÏò§Í∏∞ -->
                    <v-container v-if="dialogView==='condition'">
                        <!-- ÏãúÍ∞Ñ constraint -->
                        <div class="text-h3">Time</div>
                        <v-range-slider
                            :min="9"
                            step="1"
                            thumb-label="always"
                            :max="24"
                            v-model="timeRange"
                            strict
                        ></v-range-slider>
                        <!-- Í≥° constraint -->
                        <div class="text-h3">Songs</div>

                        <v-chip-group v-model="selectedSongs" multiple >
                            <v-chip v-for="song in project.songs" :key="song" filter>
                                {{song.title}}
                            </v-chip>
                        </v-chip-group>
                        <div class="text-h3">Dates</div>
                        <!-- ÌÅ¥Î¶≠ Ïãú, Î∞∞Ïπò Î∑∞Î°ú Î∞îÎÄåÏñ¥Ïïº Îê® -->
                        <v-card v-for="date in constrainedDates" :key="date" class="ma-0 pa-0" @click="arrangeView(date)" :ripple="true"> 
                            <v-card-title>
                                {{date}}
                            </v-card-title>
                            
                            <v-chip-group class="ma-2">
                                
                                <v-chip v-for="song in getSongs(date)" :key="song">
                                    {{song.title}}
                                </v-chip>
                            </v-chip-group>
                            
                            <v-divider></v-divider>
                        </v-card>

                    </v-container>


                    <v-container v-else-if="dialogView==='arange'">
                        <div class="text-h3">Time</div>
                        <!-- Î∞∞ÏπòÎ•º Ìï†Í±¥Îç∞?
                        ÎÇ†Ïßú ÌÅ¥Î¶≠ ÌñàÏûêÎÑà
                        Í∑∏Îüº ÎÇ†Ïßú ÎÇòÏò§Í≥†


                        Í∏∞Ï°¥ Î°úÏßÅÎåÄÎ°ú

                        ÏùºÎã® ÏãúÍ∞ÑÎåÄÎ≥ÑÎ°ú Í∞ÄÎä•Ìïú Í≥°ÏùÑ ÎùÑÏõåÏ§çÎãàÎã§. Ïù¥Í±∏ Ï∞∏Ï°∞ÌïòÎ©¥ÏÑú Í≥°ÏùÑ ÎÑ£ÏúºÎ©¥ Îê®

                        ÎÇ¥Í∞Ä ÌïòÍ≥†Ïã∂ÏùÄ ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•ÌïòÎ©¥

                        ÏïÑÎûòÏ≤òÎüº ÎùÑÏõåÏ§å

                        Í≥° chipÏùÑ ÎßàÍµ¨ ÎàÑÎ•¥Î©¥ Ïò§Î•∏Ï™ΩÏóê ÎìúÍ∞ÄÎäî ÏãúÏä§ÌÖú. 

                        Í≥° ÏµúÏÜåÏãúÍ∞Ñ ÏûÖÎ†• Ïãú, ÏûÖÎ†•Ï¥àÍ≥º 

                        ÌïúÎ≤àÏù¥ÎùºÎèÑ Îì§Ïñ¥Í∞îÏúºÎ©¥ ÏÉâÏùÑ Îã§Î•¥Í≤å
                        
                        Îã§ Ï†ïÌïòÎ©¥ Ïä§ÏºÄÏ•¥ ÏÉùÏÑ±! 
        
    
                        1Ïãú ~ 3Ïãú      |
                        Í≥° A, B, C     |
                        -------------  | ----------------- 
                        3Ïãú ~ 6Ïãú      |
                        Í≥° A, C, E     |
            
                        Í≥° Ïó¨Îü¨Î≤à ÎàÑÎ•¥Î©¥ Ïπ¥Ïö¥Ìä∏ Ïò¨ÎùºÍ∞ÄÍ≤å Ìï¥ÏÑú.. 
                        
                        

                        
                        
                         -->
                    </v-container>
                    <!-- ÏùºÎã® ÎêòÎäî ÏÇ¨Îûå Îã§ Î∂àÎü¨Ïò§Í≥† -->
                    <!-- ÏãúÍ∞ÑÎåÄ, Í≥° Îì±ÏùÑ Ï°∞Í±¥ÏùÑ Í±∏Ïñ¥Î≥∏Îã§. Í∑∏Ïóê ÎßûÏ∂∞ÏÑú disableÎêòÎäî Í≥°Ïù¥ÎÇò ÏÇ¨ÎûåÏù¥ ÏÉùÍ∏∞Í≤†ÏßÄ? -->
                    <!-- ÏãúÍ∞ÑÎåÄÎ•º Ï°∞Í±¥ÏúºÎ°ú Í±∏Î©¥?  -->

                    <!-- Ï°∞Í±¥ Îã§ Í≥®ÎûêÏúºÎ©¥ Î∞∞ÏπòÎ•º Ìï¥ÏïºÎê®. -->
                    <!-- phase Î≥ÑÎ°ú ÌéòÏù¥ÏßÄ ÏßúÏïºÎê®. ÌéòÏù¥ÏßÄ ÎÑòÍ∏∞Í∏∞ -->
                    


                </v-card>
            </v-dialog>

        </v-row>

    </v-container>
</template>

<script>
import axios from "axios"
import VueCal from 'vue-cal'
import 'vue-cal/dist/vuecal.css'
// import Datepicker from '@vuepic/vue-datepicker';
import {mdiArrowLeft, mdiArrowRight, mdiClose} from "@mdi/js"

import setToken from "@/utils/auth.js"

let url = "http://127.0.0.1:8000/api/project/";  // Ïû•Í≥† drf ÏÑúÎ≤Ñ Ï£ºÏÜå

export default {
    name: 'YourComponent',

    data : () => {
        return {
            icons : {
                mdiArrowLeft, mdiArrowRight, mdiClose
            },
            
            // calendar header
            selectedDate: null,
            activeView: "month",
            activeViewOptions : ['month', 'week', 'day'],
            
            // views 
            disable_views : ['years', 'year'],
            disable_days : [], // Ïù¥Í±∞ computedÎ°ú ÏÑ§Ï†ï. Í≥° ÎÑ£ÏùÑ Îïå 
                    
            // week / day time interval
            time_from : 8 * 60,
            time_to :23 * 60,
            time_step : 30,

            // view events in month
            eomv : 'short',
        
            // header
            weekdayHeadings : {
                Sunday : {
                    short : 'Sun',
                    color : 'red'
                },
                Monday : {
                    short : 'Mon',
                    color : 'black'
                },
                Tuesday : {
                    short : 'Tue',
                    color : 'black'
                },
                Wednesday : {
                    short : 'Wed',
                    color : 'black'
                },
                Thursday : {
                    short : 'Thu',
                    color : 'black'
                },
                Friday : {
                    short : 'Fri',
                    color : 'black'
                },
                Saturday : {
                    short : 'Sat',
                    color : 'blue'
                },

            },

            events: [
                {
                    id : 1,
                    author : 1,
                    start: '2022-11-26 14:00',
                    end: '2022-11-26 17:30',
                    title: 'Boring event',
                    content: 'CEX',
                    // split : 1
                },
                {
                start: '2022-11-26 12:00',
                end: '2022-11-26 14:00',
                title: 'Ìï©Ï£º',
                class: 'meeting',
                background: true,
                // split : 2
                },
            ],

            // add events
            openAdd : false,
            newDate : [
                new Date(), 
                new Date()
            ],
            newEvent : {
                title : "",
                content : ""
            },

            // retrieve events
            openRetrieve : false,

            selectedNewDates : new Set(),
            openAddMeeting : false,

            timeRange : [12, 22],
            selectedSongs : [],

            dialogView : 'condition',

        }
    },

    components: {
        VueCal,
        // Datepicker
    },

    methods : {
        wdHeaderStyle : function(heading){
            if (heading.label === ''){
                return ''
            } else {
                return 'color:' + this.weekdayHeadings[heading.label].color
            }
        },
        wdHeaderText : function(heading){
            if (heading.label === ''){
                return ''
            } else {
                return this.weekdayHeadings[heading.label].short
            }
        },

        onEventClick: function(event){
            event;
            console.log('eventclick')
        },

        onCellClick : function(isSelected, event){
            event;
            // isSelected === true : Ïù¥Ï†ú ÏÑ†ÌÉù ÏïàÌï®
            // isSelected === false : Ïù¥Ï†ú ÏÑ†ÌÉù Ìï®
            // selected eventsÏóêÏÑú Ï†úÍ±∞Ìï†ÏßÄ ÎßêÏßÄ ? 
            if (typeof(isSelected) === 'boolean'){
                if (!isSelected){
                    console.log(event.startDate)
                    this.selectedNewDates.add(String(event.startDate))
                } else {
                    this.selectedNewDates.delete(String(event.startDate))
                }
            } 

            // console.log('----------------------------')
            // console.log(isSelected, this.selectedNewDates)
            // console.log('----------------------------')

        },

        retrieveProject : function(){
            axios({
                method : "GET",
                url : url + this.$route.query.project_id + '/',
                headers : setToken(),
                params : {
                    user_id : localStorage.getItem('user'),
                }
            }).then((response) => {
                this.project = response.data // projectÎßå Í∞ÄÏ†∏Ïò§Ïûê. songsÎäî songs listÏóêÏÑú Í∞ÄÏ†∏Ïò§Í≥† 
                this.project.songs.map((song, index) => {
                    song.index = index
                    return this.parsePlayer(song)
                })
            }).catch((error) => {
                console.log("Failed to get retreival", error.response);
            });
        },

        parsePlayer : function(song){
            song.players.map((player) => {
                if (player.fixed){
                    //song[player.position] = player 
                    song[player.player.position] = player.player.user.name 
                }
            })
            return song
        },


        modal : function(){
            
            this.openAddMeeting = true
            this.dialogView = 'condition'
            console.log(this.selectedNewDates)
            this.getSongs()

        },

        
        // 1. Ï†ÑÏ≤¥ ÏÇ¨Ïö©ÏûêÏóê ÎåÄÌï¥ ÎÇ†ÏßúÎ≥Ñ, ÏãúÍ∞ÑÎåÄÎ≥ÑÎ°ú Í∞ÄÎä•Ìïú Í≥°ÏùÑ Ï†ÑÎ∂Ä ÎΩëÎäîÎã§. 
        // 2. Î¶¨Ïä§ÌåÖ

        // Ïù¥Í±∏ ÎÇ†ÏßúÎ≥ÑÎ°ú ÎÇòÎàÑÍ≥† Ïã∂Ïñ¥.
        // 1. Ï†ÑÏ≤¥ ÏÇ¨Ïö©ÏûêÏóê ÎåÄÌï¥ ÏùºÏ†ï contraintÎ•º Í≥†Î†§Ìï¥, ÎÇ†ÏßúÎ≥ÑÎ°ú Í∞ÄÎä•Ìïú Í≥°ÏùÑ Ï†ÑÎ∂Ä ÎΩëÏïÑÎ≥∏Îã§
        // 2. Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÏ†ÅÏúºÎ°ú Ìï©Ï£ºÏãúÍ∞Ñ Î≤îÏúÑÎ•º ÏßÄÏ†ï. global contraint
        // 3. Í≥°Ïóê ÎåÄÌïú constraint : 
        // 1Î≤àÍ≥º Ï°∞Í±¥Ïù¥ Ïó≠ÏûÑ.
        // Ïñ¥Îñ§ Í≥°Ïóê ÎåÄÌï¥, ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÎì§Î°ú Í∞ÄÎ¥Ñ
        // ÎÇ†ÏßúÏôÄ Í≥°Ïù¥ ÎèôÏãúÏóê Ï£ºÏñ¥ÏßÑ ÏÉÅÌô©. ÎêòÎÉê?
        // 

        getSongs : function(date){
            // ÏùºÎã®ÏùÄ ÌïòÎ£®Î≥ÑÎ°ú Í∞ÄÎä•Ìïú Í≥°ÏùÑ ÎΩëÏïÑÎ¥Ñ. 
            let availableSongs = Array()
            
                // ÌÉêÏÉâÏùò Î≤îÏúÑÎ•º Ï§ÑÏù¥Í∏∞ ÏúÑÌï¥. ÏùºÎ∂ÄÎùºÎèÑ Í∞ÄÎä•ÌïòÎ©¥.. 


                // let availableUsers = this.getAvailableUsers(date)

            
            for (let j in this.project.songs){
                let song = this.project.songs[j]
                
                for (let t = this.timeRange[0]; t < this.timeRange[1]; t++) {
                    console.log(song.title, date, t, this.isAvailableAt(song, date, t))
                    if(this.isAvailableAt(song, date, t)){
                        availableSongs.push(song)
                        break
                    }
                }
            }


                // 2) song. Î£®ÌîÑ ÎèåÍ∏∞Ï†ÑÏóê Í∑∏ Í≥°Îì§ÏùÑ Î®ºÏ†Ä Ï≤¥ÌÅ¨. ÌïòÎÇòÎùºÎèÑ ÏïàÎêòÎ©¥ Í∑∏ÎÇ†ÏùÄ ÏïàÎêòÎäî ÎÇ†.

                
            
            return availableSongs

        },

        isAvailableAt(song, date, time){
            let songStart = new Date(date)
            let songEnd = new Date(date)
            songStart.setHours(time)
            songEnd.setHours(time + 1)


            for (let i in song.players){
                let songplayer = song.players[i]

                if (!songplayer.fixed){
                    // fixed player Îßå Í≥†Î†§ 
                    continue
                }

                let events = songplayer.player.user.events
                for (let j in events){
                    let event = events[j]
                    let eventStart = new Date(event.start)
                    let eventEnd = new Date(event.end)
                    if (event.allDay){
                        eventEnd.setHours(23, 59, 59)
                        if (songStart <= eventEnd && songEnd > eventStart){
                            return false
                        }
                    } else {
                        if (songStart <= eventEnd && songEnd > eventStart){
                            return false
                        }    
                    }
                }
            }

            return true

        }, 

        getAvailableUsers : function(date){

            let users = new Set()
            users; date;

            date = new Date(date)
            
            for (let i in this.project.songs){
                let players = this.project.songs[i].players
                let breakpoint = false
                for (let j in players){
                    let events = players[j].user.events
                    for (let k in events){
                        let event = events[k]
                        let start = new Date(event.start)
                        let end = new Date(event.end)


                        if (event.allDay){
                            if (start <= date && end >= date){
                                // allday 1Ïùº Ï∞çÏñ¥ÎÜìÏúºÎ©¥ ÏãúÏûëÍ≥º ÎÅùÏù¥ Í∞ôÏùå.
                                // Í≤πÏπòÎ©¥ ? ÏùºÏ†ïÏù¥ ÏûàÏùå! 
                                breakpoint = true
                                break
                            }
                        } else {
                            if (start <= date && end > date){
                                // allday 1Ïùº Ï∞çÏñ¥ÎÜìÏúºÎ©¥ ÏãúÏûëÍ≥º ÎÅùÏù¥ Í∞ôÏùå.
                                breakpoint = true
                                break
                            }    
                        }
                    }
                    // Î¨¥ÏÇ¨Ìûà Î£®ÌîÑÎ•º Îπ†Ï†∏ÎÇòÏò§Î©¥?
                    if (!breakpoint){
                        users.add(players[j])
                        breakpoint = false
                    }
                }
            }
            console.log(users)


        }, 

        getAvailableSongs : function(availableUsers){
            // 
            
            availableUsers;
            let availableSongs = Array()
            return availableSongs
            
        },



        getAvailableDays : function(constraintSongs){
            // Ïù¥ Í≥°ÏùÑ Íº≠ Ìï¥ÏïºÎèº
            // Í∑∏Î•¥Î©¥ ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏ Í≥°Ïù¥ Í∞ÄÎä•ÌïúÏßÄ Ï≤¥ÌÅ¨Î•º ÌïúÎã§.
            // ÎêòÎäî ÎÇ†ÏßúÎ•º Î∞òÌôò
            constraintSongs;

            this.selectedNewDates.map((date) => {
                date;

            })

            let availableDays = Array()
            return availableDays

        },

        arrangeView : function(date){
            console.log(date)
            this.dialogView = 'arange'
        }
    },

    mounted() {
        this.retrieveProject()
    },

    computed : {
        constrainedDates() {
            if (this.selectedSongs.length === 0){
                return this.selectedNewDates
            } else{


                let dates = new Set();
                
                for (let date of this.selectedNewDates){
                    for (let j in this.selectedSongs){
                        let song = this.project.songs[this.selectedSongs[j]]
                        for (let t = this.timeRange[0]; t < this.timeRange[1]; t++) {
                            if(this.isAvailableAt(song, date, t)){
                                dates.add(date)
                            }
                        }
                    }
                }
                console.log(dates)

                return dates
            }
            
        }
    }

    // watch : {
    //     selectedSongs : {
    //         handler : function(newVal, oldVal){
    //             oldVal; newVal;
    //             console.log(newVal)
    //         },

    //         intermediate : true,
    //         deep : true
    //     }
    // }

}
</script>


<style>
.v-dialog .v-overlay__content{
    flex-direction : row;
    justify-content : center
}

.vuecal--month-view .vuecal__cell {height: 100px;}

.vuecal--month-view .vuecal__cell-content {
  justify-content: flex-start;
  height: 100%;
  align-items: flex-end;
}

.vuecal--month-view .vuecal__cell-date {padding: 4px;}
.vuecal--month-view .vuecal__no-event {display: none;}
.vuecal--week-view .vuecal__no-event {display: none;}

.vuecal__event.P {
  background: rgb(255, 98, 98);
  display: flex;
  justify-content: center;
  align-items: center;
}

.vuecal__flex[grow]{
    flex:none
}



.vuecal__flex .vuecal__cell-content .custom-cell{
    align-items: center;
    justify-content: center;

}

</style>

